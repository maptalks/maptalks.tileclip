<!DOCTYPE html>
<html>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>User Interactions - Draw tool to draw geometries</title>
<style type="text/css">
    html,
    body {
        margin: 0px;
        height: 100%;
        width: 100%
    }

    .container {
        width: 100%;
        height: 100%;
        /* background-color: black; */
    }
</style>
<link rel='stylesheet' href='https://unpkg.com/maptalks/dist/maptalks.css' />
<script type='text/javascript' src='https://unpkg.com/maptalks-gl/dist/maptalks-gl.js'></script>
<script type='text/javascript' src='https://unpkg.com/maptalks.tileclip@latest/dist/maptalks.tileclip.js'></script>

<!-- <script type='text/javascript' src='./jsts.min.js'></script> -->

<body>
    <div id="map" class="container"></div>
    <script>

        // const geoJSONRender = new jsts.io.GeoJSONReader();
        // const geoJSONWriter = new jsts.io.GeoJSONWriter();

        const tileActor = maptalks.getTileActor();
        const maskId = 'shanxi';

        const map = new maptalks.Map("map", {
            "center": [108.95986733, 34.21997952, 430.3062438964844], "zoom": 12.698416480987284, "pitch": 0, "bearing": 1.8437368186266667,
            zoomControl: true,
        });

        map.on('mousemove', e => {
            // console.log(e.terrain);
        })


        const baseLayer = new maptalks.TileLayer('base', {
            // debug: true,
            urlTemplate: "https://webst01.is.autonavi.com/appmaptile?style=6&x={x}&y={y}&z={z}",
            urlTemplate: "https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
            subdomains: ["a", "b", "c", "d"],
            // bufferPixel: 1
        })
        const baseLayer1 = new maptalks.TileLayer('base1', {
            // debug: true,
            subdomains: ["a", "b", "c", "d"],
            urlTemplate: "https://webrd01.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=8&x={x}&y={y}&z={z}",
            // urlTemplate: "https://wtb.maptiles.arcgis.com/arcgis/rest/services/World_Topo_Base/MapServer/tile/{z}/{y}/{x}",
        })

        baseLayer.on('renderercreate', function (e) {
            e.renderer.loadTileBitmap = function (url, tile, callback) {

                tileActor.clipTile({
                    tile: maptalks.Util.getAbsoluteURL(url),
                    tileBBOX: baseLayer._getTileBBox(tile),
                    projection: baseLayer.getProjection().code,
                    maskId,
                    bufferSize: tile.z - 2
                }).then(image => {
                    callback(image);
                }).catch(error => {
                    console.error(error);
                })

            };
        });


        const sceneConfig = {
            postProcess: {
                enable: true,
                antialias: {
                    enable: true,
                },
            },
        };

        const colors4 = [
            [0, '#F0F9E9'],
            [200, '#D7EFD1'],
            [400, '#A6DCB6'],
            [650, '#8FD4BD'],
            [880, '#67C1CB'],
            [1100, '#3C9FC8'],
            [1300, '#1171B1'],
            [1450, '#085799'],
            [1600, '#084586'],
        ];

        const terrain = {
            type: 'mapbox',
            //强制指定tileSize
            // tileSize: 256,
            maxAvailableZoom: 14,
            requireSkuToken: false,
            urlTemplate: "https://elevation3d.arcgis.com/arcgis/rest/services/WorldElevation3D/Terrain3D/ImageServer/tile/{z}/{y}/{x}",
            subdomains: ['a', 'b', 'c', 'd'],
            // colors: colors4,
            exaggeration: 2,
        };
        const group = new maptalks.GroupGLLayer('group', [baseLayer1, baseLayer], {
            terrain
        });


        map.setView({
            "center": [108.67551693, 32.96808206, 1517.6624755859375], "zoom": 8.626677495159905, "pitch": 64.4000000000002, "bearing": 14.015627251180604
        })

        group.on('terrainlayercreated', e => {
            const terrainLayer = group.getTerrainLayer();
            terrainLayer.getRenderer().loadTileBitmap = function (url, tile, callback, options) {
                tileActor.encodeTerrainTile({
                    url: maptalks.Util.getAbsoluteURL(url),
                    terrainType: 'arcgis',
                    // timeout: 5000
                }).then(imagebitmap => {
                    tileActor.clipTile({
                        tile: imagebitmap,
                        tileBBOX: terrainLayer._getTileBBox(tile),
                        projection: terrainLayer.getProjection().code,
                        tileSize: terrainLayer.getTileSize().width,
                        maskId
                    }).then(image => {
                        callback(null, image);
                    }).catch(error => {
                        //do some things
                        console.error(error);
                    })
                }).catch(error => {
                    //do some things
                    console.error(error);
                })
            };
        })


        fetch('./shanxi.geojson').then(res => res.json()).then(geojson => {
            const mask = geojson.features[0];


            tileActor.injectMask(maskId, mask).then(data => {
                group.addTo(map);
            }).catch(error => {
                console.error(error);
            })
        });











    </script>
</body>

</html>